# neon-postgres-setup Reference Guide

## Overview

The `neon-postgres-setup` skill automates database initialization on Neon PostgreSQL. It executes the LearnFlow schema (users, modules, topics, exercises, submissions, conversations, progress_events, struggles, learning_paths) and validates successful creation.

## Prerequisites

### 1. Create Neon Account

Visit https://neon.tech/ and sign up for free PostgreSQL hosting.

### 2. Create Project

In Neon console:
- Click "New Project"
- Name: "LearnFlow"
- Select region closest to you
- Wait for project creation

### 3. Get Connection String

In Neon console:
- Open "LearnFlow" project
- Go to "Connection string" tab
- Copy string starting with `postgresql://`
- Example: `postgresql://user:password@ep-xxx.neon.tech/learnflow`

### 4. Set Environment Variable

```bash
export NEON_CONNECTION_STRING="postgresql://user:password@ep-xxx.neon.tech/learnflow"
```

Or create `.env` file:
```
NEON_CONNECTION_STRING=postgresql://user:password@ep-xxx.neon.tech/learnflow
```

## Database Schema

The skill creates 9 tables:

1. **users** - Student and teacher accounts
   - id (primary key)
   - email (unique)
   - password_hash
   - role (student/teacher/admin)

2. **student_profiles** - Student-specific data
   - user_id (foreign key)
   - current_module
   - mastery_scores (JSONB)

3. **modules** - 8 Python learning modules
   - id (primary key)
   - name (Python Basics, Control Structures, etc.)
   - description
   - display_order

4. **topics** - Topics within modules
   - id (primary key)
   - module_id (foreign key)
   - name
   - content

5. **exercises** - Coding exercises
   - id (primary key)
   - topic_id (foreign key)
   - prompt
   - test_cases (JSONB)
   - difficulty (1-5)

6. **submissions** - Student code submissions
   - id (primary key)
   - student_id (foreign key)
   - exercise_id (foreign key)
   - code
   - test_results (JSONB)

7. **conversations** - AI agent interactions
   - id (primary key)
   - student_id (foreign key)
   - agent_type (triage/concepts/code-review)
   - messages (JSONB)

8. **progress_events** - Learning progress tracking
   - id (primary key)
   - student_id (foreign key)
   - event_type
   - value
   - timestamp

9. **struggles** - Struggle detection
   - id (primary key)
   - student_id (foreign key)
   - trigger_type
   - severity (1-5)
   - resolved (boolean)

## Actions

### init (Default)

Create fresh schema from scratch:

```bash
claude "Use neon-postgres-setup skill"
```

Creates all tables, indexes, and inserts:
- 8 Python modules
- 3 sample topics for Python Basics
- 1 sample exercise

### verify

Check if database is ready:

```bash
claude "Use neon-postgres-setup skill with action=verify"
```

Checks:
- All 9 tables exist
- All indexes created
- 8 modules present
- Connection working

### reset

Drop and recreate schema (DESTRUCTIVE):

```bash
claude "Use neon-postgres-setup skill with action=reset"
```

⚠️ WARNING: Deletes all data. Use only in development.

### backup

Create SQL dump of current schema:

```bash
claude "Use neon-postgres-setup skill with action=backup"
```

Creates `learnflow-schema-backup.sql` with schema definition.

## Advanced Configuration

### Custom Connection String

Pass connection string directly (overrides env var):

```bash
claude "Use neon-postgres-setup skill with connection-string='postgresql://user:pass@host/db'"
```

### Load Initial Data

Insert sample students and exercises:

```bash
claude "Use neon-postgres-setup skill with load-sample-data"
```

### Execute Custom SQL

Run additional SQL after schema creation:

```bash
claude "Use neon-postgres-setup skill with custom-sql-file=schema-additions.sql"
```

## Troubleshooting

### Connection Error: "Connection refused"

- Verify connection string is correct
- Check network connectivity to Neon
- Verify Neon project is active (not suspended)

### Error: "relation users already exists"

Database schema already created. Use:
```bash
claude "Use neon-postgres-setup skill with action=verify"
```

To check status, or use `action=reset` to recreate.

### Error: "permission denied"

Connection string may be read-only. In Neon console:
- Select project
- Go to "Connection string" tab
- Use "main" password (not read-only token)

### Tables Created but No Data

Use `load-sample-data` flag:
```bash
claude "Use neon-postgres-setup skill with load-sample-data"
```

## Integration with Other Skills

### With fastapi-service-template

Services generated by `fastapi-service-template` will automatically:
- Connect to database via `NEON_CONNECTION_STRING`
- Use ORM models matching this schema
- Execute migrations if needed

### With nextjs-k8s-deploy

Frontend will access database through API gateway:
1. Frontend makes HTTP request to service
2. Service queries database
3. Response returned to frontend

### With docusaurus-deploy

Documentation can include schema diagrams generated from this script.

## Kubernetes Integration

The skill generates K8s secret for database connection:

```bash
kubectl create secret generic neon-secret \
  --from-literal=connection-string="$NEON_CONNECTION_STRING" \
  -n learnflow
```

Pods reference secret in deployment:

```yaml
env:
- name: DATABASE_URL
  valueFrom:
    secretKeyRef:
      name: neon-secret
      key: connection-string
```

## Performance Tips

1. **Connection Pooling**: Use pgBouncer in Neon console for better performance
2. **Indexes**: Automatically created on frequently-queried columns
3. **JSONB Fields**: Excellent for schema flexibility (mastery_scores, test_cases, messages)
4. **Full-Text Search**: Can be added on topics.content for search features

## Monitoring

Check database status in Neon console:
- Active connections
- Query performance
- Storage usage
- Backup status

## Backup and Recovery

### Automatic Backups

Neon provides daily automated backups (14-day retention in free plan).

### Manual Backup

```bash
claude "Use neon-postgres-setup skill with action=backup"
```

Creates SQL dump for safekeeping.

### Point-in-Time Recovery

In Neon console, go to "Backups" tab to restore from specific time.
